---
title: "RTM standard pipeline processes"
author: "Amira Swedan"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

This data pipeline automate the process of RTM data management for the RTM core variables related to the key indicators. The standard pipeline procedures are aligned with [RBC RTM SOPs](https://wfp-my.sharepoint.com/:w:/g/personal/amira_swedan_wfp_org/EVistHIsU_xAsdsF-2SEcRoB-cMrwS-IuyjyscsUVLfuig?e=SH9hHK) that includes a detailed explanation about the methodology applied in this script.
 

The key functions implemented in this standard pipeline are:

1. Raw data extraction
2. Renaming and selecting core variables
2. Data Quality Checks
3. Data recoding 
4. Indicators computation
5. Weights construction
6. Connecting to the regional master table 

# Load packages and read relevant input files

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(httr)
library(jsonlite)
library(lubridate)

pipInput = read_excel('RTM_pipeline_input.xlsx')
pipInput$StartDate = format(as.Date(pipInput$StartDate), "%m/%d/%Y")
pipInput$EndDate = format(as.Date(pipInput$EndDate), "%m/%d/%Y")

```


# Connect and extract raw data

Connect through Crystal API to fetch the raw data.

To connect you need to pass the key parameters (`APIKey`, `start date`, `end date`) for each country separately to Crystal_API_connect function.

The parameters should be inserted in the pipeline input file, the configuration list for each country (Lebanon,Syria, and Yemen) will be updated automatically.

To add a new country, first modify the input file and create a new configuration list that should be passed to the connection function. 

```{r extract raw data, message=FALSE, warning=FALSE, echo=TRUE}


Syria_config = list ('APIKey' = paste("Syria_" , unlist (strsplit(pipInput$EndDate[pipInput$CountryCode == 'Syria'] , "/")) [1] , unlist (strsplit(pipInput$EndDate[pipInput$CountryCode == 'Syria'] , "/")) [3] , sep = ""),  'DateFrom' = pipInput$StartDate[pipInput$CountryCode == 'Syria']  , 'DateTo' = pipInput$EndDate[pipInput$CountryCode == 'Syria'] )

Yemen_config = list ('APIKey' = paste("Yemen1_" , unlist (strsplit(pipInput$EndDate[pipInput$CountryCode == 'Yemen1'] , "/")) [1] , unlist (strsplit(pipInput$EndDate[pipInput$CountryCode == 'Yemen1'] , "/")) [3] , sep = ""),  'DateFrom' = pipInput$StartDate[pipInput$CountryCode == 'Yemen1']  , 'DateTo' = pipInput$EndDate[pipInput$CountryCode == 'Yemen1'] )

Leb_config = list ('APIKey' = "Lebanon_112022",  'DateFrom' = pipInput$StartDate[pipInput$CountryCode == 'Lebanon']  , 'DateTo' = pipInput$EndDate[pipInput$CountryCode == 'Lebanon'] )

##########################################################
Crystal_API_connect <- function (con_config) {
  
json_body <- jsonlite::toJSON(con_config, auto_unbox = TRUE)

print (json_body)
  
 r =  POST(url = 'http://campaignapi.crystelcall.com/CampaignAPI/api/Campaign' , body = json_body , add_headers('Content-Type'='application/json')) 
 
 if (r$status_code == 200) {
   print ('Crystal API connection is ok ')
 }
 else {
     print (paste0('ERROR:reading from Crystal API returned the status code ' , r$status_code))
 }
 
 Rawdata = fromJSON(rawToChar(r$content))
 
 return(Rawdata)
 
}
##################################################

SyriaRaw = Crystal_API_connect (Syria_config)
SyriaRaw = SyriaRaw[SyriaRaw$Completed == 'Y' ,]
print(paste0('total number of completed surveys for Syria survey is ' , nrow(SyriaRaw)))

YemenRaw = Crystal_API_connect(Yemen_config)
YemenRaw = YemenRaw[YemenRaw$Completed == 'Y' ,]
print(paste0('total number of completed surveys for Yemen survey is ' , nrow(YemenRaw)))

LebRaw = Crystal_API_connect(Leb_config)
LebRaw = LebRaw[LebRaw$Completed == 'Y' ,]
print(paste0('total number of completed surveys for Lebanon survey is ' , nrow(LebRaw)))


 
```


# Renaming variables according to the standard codebook, and select only core questions

```{r renaming and selecting, echo=TRUE, message=FALSE, warning=FALSE}
# Syria
SyriaRaw_reduced = SyriaRaw %>% select (ADMIN0Name = Country, ADMIN1Name = City, ADMIN2Name = Area,RspID,SvyDate,EnuName = Agent ,HHH_YN,HHHSex,HHHAge,HHHEducation,RESPAge,HHSize , HHDispl, IDPDuration,HouseType,HWaterSRC, FCSStap, FCSPulse, FCSVeg, FCSFruit,FCSPr, FCSDairy, FCS_SRf, MktAccess_1M, MktAccessCnstr, rCSILessQlty, rCSIBorrow, rCSIMealNb , rCSIMealSize, rCSIMealAdult, Lcs_stress_DomAsset, Lcs_stress_Saving, Lcs_stress_SellFoodRation, Lcs_stress_CrdtFood, Lcs_crisis_OutSchool, Lcs_crisis_ProdAssets, Lcs_crisis_Migration, Lcs_em_ResAsset, LcsR_em_FemAnimal, Lcs_em_Begged)

#Yemen
YemenRaw_reduced = YemenRaw %>% select(RspID, SvyDate,EnuName = Agent ,RESPAge = BirthYear, HHHSex = HoHSex, ADMIN0Name = Country, ADMIN1Name = City, ADMIN2Name = Area, HHSize= HHSize_90days, HHDispl = IDP_YN, HHChronIllNb = HH65_Disease, FCSStap = Staples, FCSPulse = Pulses, FCSVeg = Veg, FCSFruit = Fruits, FCSPr = Proteins, FCSDairy = Dairy, FCSFat = Fats, FCSSugar = Sugars, FCS_SRf = FoodSrc1, rCSILessQlty = LessExpensiveFood, rCSIBorrow = BorrowOrHelp, rCSIMealNb = ReduceNumMeals, rCSIMealSize = LimitPortionSize, rCSIMealAdult = RestrictConsumption,LcsEN_stress_DomAsset = LC_2_SoldAsset, LcsEN_stress_CrdtFood = LC_3_CreditFood, LcsEN_stress_Saving = LC_4_SpentSaving, LcsEN_stress_BorrowCash = LC_5_BorrowMoney, LcsEN_crisis_ProdAssets = LC_6_SoldProduction, LcsEN_crisis_Health = LC_7_ReduceHealth, LcsEN_crisis_OutSchool = LC_8_WithdrawSchool, LcsEN_em_ResAsset = LC_9_SoldHome, LcsEN_em_Begged = LC_10_Begged , LcsEN_em_LastAnimal = LC_11_LastAnimal, LhCSIEnAccess = LC_MainReason, HHIncFirst_SRi = Income_MainSrc, HHIncChg_YN_1M = Income_Change  )

#Lebanon
LebRaw_reduced = select(EnuName = Agent, ADMIN0Name = Country, ADMIN1Name = City, ADMIN2Name = Area, SvyDate,RESPAge,HouseType= HHHousingCurrent, FCSStap, FCSPulse, FCSDairy, FCSPr, FCSVeg, FCSFruit, FCSFat, FCSSugar, rCSILessQlty, rCSIBorrow, rCSIMealSize, rCSIMealNb, rCSIMealAdult = rCSIMealAdul, LhCSIDomAsset )

```


# Recoding

```{r recoding, echo=TRUE, message=FALSE, warning=FALSE}

```




# Quality checks and flags

```{r Check data quality, echo=TRUE, message=FALSE, warning=FALSE}

```



# Food security indicators calculation

```{r calculate livelihood coping indicators, echo=TRUE, message=FALSE, warning=FALSE}

```


# Construct weights

```{r Construct weights, echo=TRUE, message=FALSE, warning=FALSE}

```


# Connect to regional master table

```{r upload data, echo=TRUE, message=FALSE, warning=FALSE}

```






